<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">

  <!-- Load camera library -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <!-- Load drawing library -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <!-- Load hand shape recognition library -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>

<body>
  MediaPipe Hand Tracking
  <button id="start">start</button>
  <button id="stop">stop</button>

  
  file name(d-dd):
  <input type="text" id="fileName" value="1-01" size="5" maxlength="5">

  <button id="download">download</button>

  <div class="container">
    
    <canvas id="output" width="1280" height="720"></canvas>

  
    <video id="input"></video>
  </div>
</body>

<script type="module">
  
  const video = document.getElementById('input');
  const canvas = document.getElementById('output');
  const ctx = canvas.getContext('2d');

  
  var recording = false;

  
  const hands = new Hands({
    locateFile: (file) => {
      return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }
  });


  const camera = new Camera(video, {
    onFrame: async () => {
      await hands.send({image: video});
    },
    width: 1280,
    height: 720
  });

  
  hands.setOptions({
    maxNumHands: 2,
    modelComplexity: 1,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  
  hands.onResults(results => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

    if (results.multiHandLandmarks) {
      results.multiHandLandmarks.forEach(landmarks => {
        // Visualize the skeleton with green lines
        drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});

        // Visualize Landmarks in red
        drawLandmarks(ctx, landmarks, {color: '#FF0000', lineWidth: 1});

        ctx.font = '16px serif';
        landmarks.forEach((e, i) => {
          // Draw the index of Landmarks
          ctx.fillText(i, e.x * canvas.width, e.y * canvas.height);
        });

        if (recording) {
          // Get the file name from the text box for file name input
          let fileName = document.getElementById("fileName").value;
          // Prepare to create a csv(comma separated values) file
          let csvContent = "data:text/csv;charset=utf-8,";
          // Create the header of the csv
          csvContent += "index,x,y,z\n";
          
          landmarks.forEach((e, i) => {
            csvContent += `${i},${e.x},${e.y},${e.z}\n`;
          });
        
          console.log(csvContent);
        
          var encodedUri = encodeURI(csvContent);
          var link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", fileName + ".csv");
          document.body.appendChild(link);
          
          link.click();

               
          let result = fileName.split("-");
          result[1] = String(Number(result[1]) + 1).padStart(2, '0');
          fileName = result.join("-");
          console.log(fileName);
          document.getElementById("fileName").value = fileName;

    
          recording = false;
        }
      });
    }
  });


  document.getElementById('start')
    .addEventListener('click', () => camera.start());


  document.getElementById('stop')
    .addEventListener('click', () => camera.stop());

  
  document.getElementById('download')
    .addEventListener('click', () => {recording = true;});

  
  camera.start();
</script>

</html>